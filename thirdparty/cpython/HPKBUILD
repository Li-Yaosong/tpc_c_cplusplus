# Copyright (c) 2023, HiHope Community.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Contributor: jiajiahao <jia_jiahao@runkaihong.com.cn>
# Maintainer: jiajiajiao <jia_jiahao@runkaihong.com.cn>

pkgname=cpython
pkgver=3.8 
pkgrel=0
pkgdesc=""
url="https://www.python.org/"
archs=("arm64-v8a") # armeabi-v7a版本编译有问题，只能编译64位的 
license=("MIT")
depends=("gettext" "gdbm" "openssl" "zlib" "libffi" "tcl" "sqlite" "openssl_quic" "xz" "libuuid" "bzip2")
makedepends=()
source="https://codeload.github.com/python/${pkgname}/zip/refs/heads/$pkgver"

autounpack=true 
downloadpackage=true 
buildtools="configure"

builddir=$pkgname-$pkgver
packagename=$builddir.zip 
patchflag=true

source envset.sh
host=
prepare() {
    if [ $patchflag == true ];then
        cd $builddir
        # 打patch的原因：
        # 1.解决cpython/Modules/socketmodule.c文件的编译问题,这个问题最终会导致编译_socket模块编译失败，在linux内核中CAN_RAW_FD_FRAMES的值是5
        # 2.解决cpython/Modules/_cryptmodule.c文件的编译问题,crypt函数导致无法编译
        patch -p1 < `pwd`/../cpython_oh_pkg.patch
        # patch只需要打一次,关闭打patch
        patchflag=false
        cd $OLDPWD
    fi
    
    rm -rf $builddir-$ARCH-build # 重复编译的时候删除上一次编译的目录
    cp -arf $builddir $builddir-$ARCH-build # 创建cpython-3.8-arm64-v8a-build和cpython-3.8-armeabi-v7a-build
    if [ $ARCH == "armeabi-v7a" ]
    then
        host=arm-linux-gnueabi # 编译arm32的cpython的abi是arm-linux-gnueabi
    elif [ $ARCH == "arm64-v8a" ]
    then
        host=aarch64-linux-gnu # 编译arm64的cpython的abi是aarch64-linux-gnu
    else
        echo "${ARCH} not support"
	return -1
    fi
}

build() {
    cd $builddir-$ARCH-build
    ./configure "$@" --host=$host --build=x86_64-pc-linux-gnu --disable-ipv6 ac_cv_file__dev_ptmx=no ac_cv_file__dev_ptc=no --enable-optimizations \
                     CFLAGS="-Wno-deprecated-declarations -Wno-unreachable-code -Wno-implicit-const-int-float-conversion -Wno-sign-compare -Wno-int-to-pointer-cast -Wno-implicit-function-declaration -Wno-int-conversion"\
                     LDFLAGS="-L$LYCIUM_ROOT/usr/openssl_quic/$ARCH/lib -L$LYCIUM_ROOT/usr/gettext/$ARCH/lib -L$LYCIUM_ROOT/usr/tcl/$ARCH/lib -L$LYCIUM_ROOT/usr/xz/$ARCH/lib -L$LYCIUM_ROOT/usr/libuuid/$ARCH/lib -L$LYCIUM_ROOT/usr/zlib/$ARCH/lib -L$LYCIUM_ROOT/usr/openssl/$ARCH/lib -L$LYCIUM_ROOT/usr/gdbm/$ARCH/lib -L$LYCIUM_ROOT/usr/bzip2/$ARCH/lib -L$LYCIUM_ROOT/usr/sqlite/$ARCH/lib -L$LYCIUM_ROOT/usr/libffi/$ARCH/lib" \
                     CPPFLAGS="-I$LYCIUM_ROOT/usr/openssl_quic/$ARCH/include -I$LYCIUM_ROOT/usr/gettext/$ARCH/include -I$LYCIUM_ROOT/usr/tcl/$ARCH/include -I$LYCIUM_ROOT/usr/xz/$ARCH/include -I$LYCIUM_ROOT/usr/libuuid/$ARCH/include -I$LYCIUM_ROOT/usr/zlib/$ARCH/include -I$LYCIUM_ROOT/usr/openssl/$ARCH/include -I$LYCIUM_ROOT/usr/gdbm/$ARCH/include -I$LYCIUM_ROOT/usr/bzip2/$ARCH/include -I$LYCIUM_ROOT/usr/libffi/$ARCH/include -I$LYCIUM_ROOT/usr/sqlite/$ARCH/include" \                     
                     > $buildlog 2>&1
    $MAKE V=1 >> $buildlog 2>&1
    make install prefix=$builddir-$ARCH-build-install # 安装python到指定路径(必需)
    ret=$?  
    cd $OLDPWD
    return $ret
}

package() {
    cd $builddir-$ARCH-build
    $MAKE install >> $buildlog 2>&1
    cd $OLDPWD
}

check() {
    echo "The test must be on an OpenHarmony device!"
    # TODO
}

# 清理环境
cleanbuild() {
    rm -rf ${PWD}/$builddir #${PWD}/$packagename
}
