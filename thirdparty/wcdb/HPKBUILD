# Copyright (c) 2025 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Contributor: zws <zhouwusong05@chinasoftinc.com>
# Maintainer: zws <zhouwusong05@chinasoftinc.com>
pkgname=wcdb
pkgver=v2.1.14
pkgrel=0
pkgdesc="WCDB database library with both shared and static libraries"
url="https://github.com/Tencent/wcdb"
archs=( "arm64-v8a" "x86_64" "armeabi-v7a")
license=("MIT")
depends=("openssl" "zlib")
makedepends=()

source="https://github.com/Tencent/wcdb/archive/refs/tags/v2.1.14.tar.gz"
downloadpackage=true  
autounpack=true

builddir=$pkgname-${pkgver:1}
packagename=$builddir.tar.gz

patchflag=true

ZSTD_URL="https://github.com/facebook/zstd/archive/refs/tags/v1.5.4.tar.gz"
OPENSSL_URL="https://github.com/openssl/openssl/archive/refs/tags/openssl-3.6.0.tar.gz"
SQLCIPHER_URL="https://github.com/Tencent/sqlcipher/archive/refs/tags/v1.4.7.tar.gz"


prepare() {
    if $patchflag
    then
    cd $builddir
    
    wget -O zstd.tar.gz "$ZSTD_URL" >> "$publicbuildlog" 2>&1
    if [ $? -ne 0 ]; then
        return -2
    fi
    tar -zxf zstd.tar.gz -C zstd --strip-components=1 >> "$publicbuildlog" 2>&1
    rm -f zstd.tar.gz

    wget -O openssl.tar.gz "$OPENSSL_URL" >> "$publicbuildlog" 2>&1
    if [ $? -ne 0 ]; then
        return -3
    fi
    tar -zxf openssl.tar.gz -C openssl --strip-components=1 >> "$publicbuildlog" 2>&1
    rm -f openssl.tar.gz

    wget -O sqlcipher.tar.gz "$SQLCIPHER_URL" >> "$publicbuildlog" 2>&1
    if [ $? -ne 0 ]; then
        return -4
    fi
    tar -zxf sqlcipher.tar.gz -C sqlcipher --strip-components=1 >> "$publicbuildlog" 2>&1
    rm -f sqlcipher.tar.gz

    mkdir -p tools/prebuild/openssl/ohos/
    cp -rf $LYCIUM_ROOT/usr/openssl/* tools/prebuild/openssl/ohos/
    mkdir -p tools/prebuild/zlib/ohos/
    cp -rf $LYCIUM_ROOT/usr/zlib/* tools/prebuild/zlib/ohos/
    patch -p1 < "$PKGBUILD_ROOT/wcdb_oh_pkg.patch" > $publicbuildlog 2>&1
    patchflag=false
    cd $OLDPWD
    fi
}

build() {
    cd $builddir
    
    ${OHOS_SDK}/native/build-tools/cmake/bin/cmake "$@" -DCMAKE_C_FLAGS="-Wl,-Bsymbolic" -DCMAKE_CXX_FLAGS="-Wl,-Bsymbolic" -B$ARCH-build -S./src > $buildlog 2>&1
    $MAKE VERBOSE=1 -C $ARCH-build >> $buildlog 2>&1
    ret=$?
    cd $OLDPWD
    return $ret
}

package() {
    cd $builddir
    mkdir -p $LYCIUM_ROOT/usr/wcdb/$ARCH/include
    find "./src/cpp" -type f -name "*.h" | xargs cp -t $LYCIUM_ROOT/usr/wcdb/$ARCH/include/
    find "./src/cpp" -type f -name "*.hpp" | xargs cp -t $LYCIUM_ROOT/usr/wcdb/$ARCH/include/
    find "./src/common" -type f -name "*.h" | xargs cp -t $LYCIUM_ROOT/usr/wcdb/$ARCH/include/
    find "./src/common" -type f -name "*.hpp" | xargs cp -t $LYCIUM_ROOT/usr/wcdb/$ARCH/include/

    mkdir -p $LYCIUM_ROOT/usr/wcdb/$ARCH/lib
    cp $ARCH-build/libWCDB.so $LYCIUM_ROOT/usr/wcdb/$ARCH/lib
    cd $OLDPWD
}

check() {
    cd $builddir
    cp $ARCH-build/lib/libgtest_main.so.1.15.2 $LYCIUM_ROOT/usr/wcdb/$ARCH/lib
    cp $ARCH-build/lib/libgtest.so.1.15.2 $LYCIUM_ROOT/usr/wcdb/$ARCH/lib
    if [ $ARCH == "arm64-v8a" ]
    then
        cp ${OHOS_SDK}/native/llvm/lib/aarch64-linux-ohos/libc++_shared.so $LYCIUM_ROOT/usr/$pkgname/$ARCH/lib/
    elif [ $ARCH == "armeabi-v7a" ]
    then
        cp ${OHOS_SDK}/native/llvm/lib/arm-linux-ohos/libc++_shared.so $LYCIUM_ROOT/usr/$pkgname/$ARCH/lib/
    elif [ $ARCH == "x86_64" ]
    then
        cp ${OHOS_SDK}/native/llvm/lib/x86_64-linux-ohos/libc++_shared.so $LYCIUM_ROOT/usr/$pkgname/$ARCH/lib/
    fi
    cd $OLDPWD
}

cleanbuild() {
    rm -rf ${PWD}/$builddir
}
