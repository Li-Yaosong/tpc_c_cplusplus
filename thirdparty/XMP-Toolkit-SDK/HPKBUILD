# Copyright (c) 2025 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Contributor: <1321018403@qq.com>
# Maintainer: <1321018403@qq.com>

pkgname=XMP-Toolkit-SDK
pkgver=2025.03
pkgrel=0
pkgdesc="The Adobe XMP Toolkit SDK is a powerful open-source metadata processing toolkit that allows developers to integrate XMP (Extensible Metadata Platform) functionality into their products. The XMPCore library provides APIs for parsing, manipulating, and serializing metadata, while the XMPFiles library offers APIs for locating, adding, or updating XMP metadata in files."
url="https://github.com/adobe/$pkgname"
archs=("armeabi-v7a" "arm64-v8a")
license=("BSD 3-Clause License")
depends=()
makedepends=()
source="https://github.com/adobe/XMP-Toolkit-SDK/archive/refs/tags/v2025.03.tar.gz"

downloadpackage=true
autounpack=true
buildtools=cmake

builddir=XMP-Toolkit-SDK-$pkgver
packagename=$builddir.tar.gz

patchflag=true
prepare() {

    if [ ! -d zlib-1.3.1 ]; then
        if [ ! -f zlib-1.3.1.tar.gz ]; then
            curl -LO https://www.zlib.net/zlib-1.3.1.tar.gz
        fi
        tar -vxf zlib-1.3.1.tar.gz
    fi

    if [ ! -d expat-2.5.0 ]; then
        if [ ! -f expat-2.5.0.tar.gz ]; then
            curl -LO https://github.com/libexpat/libexpat/releases/download/R_2_5_0/expat-2.5.0.tar.gz
        fi
        tar -vxf expat-2.5.0.tar.gz
    fi

    if [ $patchflag == true ];then
        cd $builddir
        patch -p1 < ../XMP-Toolkit-SDK_2025.03_oh_pkg.patch > $publicbuildlog 2>&1
        cp -r ../expat-2.5.0/lib/ third-party/expat
        cp ../zlib-1.3.1/*.[ch] third-party/zlib
        cd $OLDPWD
        patchflag=false
    fi

    mkdir -p $builddir/$ARCH-build
    echo "prepare ok"
}

build() {
    cd $builddir
    ${OHOS_SDK}/native/build-tools/cmake/bin/cmake "$@" \
    -DXMP_BUILD_STATIC=OFF \
    -DOHOS_ARCH=$ARCH -S ./build -B $ARCH-build -L > $buildlog 2>&1

    $MAKE -C $ARCH-build VERBOSE=1 >> $buildlog 2>&1
    ret=$?
    cd $OLDPWD
    return $ret
}

package() {
    cd $builddir
    mkdir -p $LYCIUM_ROOT/usr/$pkgname/$ARCH/lib/
    cp -r public/include/ $LYCIUM_ROOT/usr/$pkgname/
    cp -f public/libraries/$ARCH-build/release/*.so $LYCIUM_ROOT/usr/$pkgname/$ARCH/lib/
    cd $OLDPWD
}

check() {
    if [ $ARCH == "arm64-v8a" ]
    then
        cp ${OHOS_SDK}/native/llvm/lib/aarch64-linux-ohos/libc++_shared.so $LYCIUM_ROOT/usr/$pkgname/$ARCH/lib/
    elif [ $ARCH == "armeabi-v7a" ]
    then
        cp ${OHOS_SDK}/native/llvm/lib/arm-linux-ohos/libc++_shared.so $LYCIUM_ROOT/usr/$pkgname/$ARCH/lib/
    fi
}

cleanbuild() {
    rm -rf ${PWD}/$builddir #${PWD}/$packagename
}
