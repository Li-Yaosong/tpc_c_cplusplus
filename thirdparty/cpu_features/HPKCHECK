# This is an example HPKCHECK file. Use this as a start to creating your own,
# and remove these comments.

# Contributor: wangle <604413545@qq.com>
# Maintainer: wangle <604413545@qq.com>

source HPKBUILD > /dev/null 2>&1
logfile=${LYCIUM_THIRDPARTY_ROOT}/${pkgname}/${pkgname}_${ARCH}_${OHOS_SDK_VER}_test.log
test_dir=test

checkprepare(){
   > "${logfile}"
   return 0
}

openharmonycheck() {
   res=0
   cd ${builddir}/${ARCH}-build
   
   if [ ! -d "${test_dir}" ]; then
      echo "错误: 测试目录不存在: ${test_dir}" >> "${logfile}" 2>&1
      return 1
   fi
   
   # 进入测试目录
   cd "${test_dir}" || {
      echo "错误: 无法进入目录: ${test_dir}" >> "${logfile}" 2>&1
      return 1
   }
   
   if [ -f "./bit_utils_test" ]; then
      ./bit_utils_test >> "${logfile}" 2>&1
      ((res+=$?))
   fi
      
   if [ -n "$ARCH" ]; then
      if [ "$ARCH" = "arm64-v8a" ] && [ -f "./cpuinfo_aarch_test" ]; then
        ./cpuinfo_aarch_test >> "${logfile}" 2>&1
        ((res+=$?))
      elif [ "$ARCH" = "armeabi_v7a" ] && [ -f "./cpuinfo_arm_test" ]; then
        ./cpuinfo_arm_test >> "${logfile}" 2>&1
        ((res+=$?))
      elif [ "$ARCH" = "x86_64" ] && [ -f "./cpuinfo_x86_test" ]; then
        ./cpuinfo_x86_test >> "${logfile}" 2>&1
        ((res+=$?))
      fi
   fi

   if [ -f "./stack_line_reader_test" ]; then
      ./stack_line_reader_test >> "${logfile}" 2>&1
      ((res+=$?))
   fi
   
   if [ -f "./string_view_test" ]; then
      ./string_view_test >> "${logfile}" 2>&1
      ((res+=$?))
   fi
   

   cd "$OLDPWD" || return 1
   
   if [ $res -eq 0 ]; then
      echo "所有测试通过" >> "${logfile}"
   else
      echo "部分测试失败，错误码: $res" >> "${logfile}"
   fi
   
   return $res
}
