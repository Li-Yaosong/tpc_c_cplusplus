# Contributor: Jeff Han <hanjinfei@foxmail.com>
# Maintainer: Jeff Han <hanjinfei@foxmail.com>

# 警告: libice 依赖 X11 头文件中的数据结构,因此需要 X11 的头文件,依赖涉及到X11头文件存放在 X11 目录中.

pkgname=libice
pkgver=libICE-1.1.1
pkgrel=0
pkgdesc="Inter-Client Exchange Library"
url="https://gitlab.freedesktop.org/xorg/lib/libice"
archs=("armeabi-v7a" "arm64-v8a")
license=("The libice Open Source License")
depends=()
makedepends=()

source="https://gitlab.freedesktop.org/xorg/lib/$pkgname/-/archive/$pkgver/$pkgname-$pkgver.tar.gz"

autounpack=true
downloadpackage=true
buildtools="configure"

builddir=$pkgname-${pkgver}
packagename=$builddir.tar.gz

source envset.sh
host=

prepare() {
    cp -rf $builddir $builddir-$ARCH-build
    if [ $ARCH == "armeabi-v7a" ]
    then
        setarm32ENV
        host=arm-linux
    elif [ $ARCH == "arm64-v8a" ]
    then
        setarm64ENV
        host=aarch64-linux
    else
        echo "${ARCH} not support"
        return -1
    fi
    export CFLAGS="-I$PKGBUILD_ROOT $CFLAGS"
}
# "error: must install xorg-macros": sudo apt-get install xutils-dev
build() {
    cd $builddir-$ARCH-build

    patch -p1 < `pwd`/../libice_pkg.patch

    ./autogen.sh "$@" --host=$host --disable-silent-rules > $buildlog 2>&1
    $MAKE >> $buildlog 2>&1
    ret=$?
  
    ${OHOS_SDK}/native/build-tools/cmake/bin/cmake "$@" -DOHOS_ARCH=$ARCH -DFT_DISABLE_BROTLI=ON -DFT_DISABLE_BZIP2=ON -DFT_DISABLE_HARFBUZZ=ON -DFT_DISABLE_PNG=ON -DFT_DISABLE_ZLIB=ON -DFT_ENABLE_ERROR_STRINGS=ON -Bexample -Sexample > $buildlog 2>&1

    cd $OLDPWD && cd $builddir-$ARCH-build/example
    $MAKE icetest VERBOSE=1 >> $buildlog 2>&1
    ret=$?
    cd $OLDPWD
    
    return $ret
}

package() {
    cd $builddir-$ARCH-build
    $MAKE install >> $buildlog 2>&1
    ret=$?
    cd $OLDPWD
    return $ret
}

check() {
    echo "The test must be on an OpenHarmony device!"
}

recoverpkgbuildenv() {
    unset host
    if [ $ARCH == "armeabi-v7a" ]
    then
        unsetarm32ENV
    elif [ $ARCH == "arm64-v8a" ]
    then
        unsetarm64ENV
    else
        echo "${ARCH} not support"
        return -1
    fi
}

# 清理环境
cleanbuild() {
    rm -rf ${PWD}/$builddir $builddir-armeabi-v7a-build $builddir-arm64-v8a-build #${PWD}/$packagename  
}
